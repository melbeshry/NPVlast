sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/Input","sap/m/MessageToast","sap/m/VBox"],function(e,t,o,r,a,n,i){"use strict";return e.extend("project1.controller.Sales",{onInit:function(){this._isDataChanged=false;const e=new URLSearchParams(window.location.search);const o=e.get("p")||"";let r={};if(o){try{const e=o.split(".")[1];const t=JSON.parse(atob(e));let a=t.deliveryDate||(new Date).toLocaleDateString("en-GB");if(t.deliveryDate){const e=new Date(t.deliveryDate);if(!isNaN(e)){a=e.toISOString().split("T")[0]}}r={discountRate:t.discountRate||"",unitNpv:t.unitNpv||"",pricePlan:t.pricePlan||"",leadId:t.leadId||"",projectId:t.projectID||"",projectType:t.projectType||"",psId:t.PSID||"",pcId:t.PCID||"",unitId:t.unitID||"",deliveryDate:a,tenant:t.tenant}}catch(e){console.error("Error decoding JWT token:",e);n.show("Error: Invalid JWT token")}}else{console.error("No JWT token found in URL");n.show("Error: No token provided");r={discountRate:"",unitNpv:"",pricePlan:"",leadId:"",projectId:"",projectType:"",psId:"",pcId:"",unitId:"",deliveryDate:(new Date).toLocaleDateString("en-GB"),tenant:"DEV"}}if(o==="scv2"){r={discountRate:"30.25",unitNpv:"7500000.00",pricePlan:"5YP",leadId:"4045",projectId:"ZAHRA",projectType:"NUCA",psId:"PS-67",pcId:"7000000",unitId:"ZAHRB2",deliveryDate:"10.10.2027",tenant:"dev"}}const a=new t({isSimulationDone:false,unitNpv:r.unitNpv,discountRate:r.discountRate,leadId:r.leadId,pricePlan:r.pricePlan,project:{projectId:r.projectId},deliveryDate:r.deliveryDate,projectType:r.projectType,unitId:r.unitId,psId:r.psId,pcId:r.pcId,tenant:r.tenant,tableData:[],futureValue:"",npv:""});this.getView().setModel(a,"sales");var i=this.getOwnerComponent().getModel("npvModel");if(!i){console.error("OData model not found.");n.show("Error: OData model not available");return}console.log("OData Model:",i);i.getMetaModel().requestObject("/Periods/").then(function(e){console.log("Periods Metadata:",e)}).catch(function(e){console.error("Error fetching Periods metadata:",e)});i.getMetaModel().requestObject("/PeriodRelations/").then(function(e){console.log("PeriodRelations Metadata:",e)}).catch(function(e){console.error("Error fetching PeriodRelations metadata:",e)});i.getMetaModel().requestObject("/Configurations/").then(function(e){console.log("Configurations Metadata:",e)}).catch(function(e){console.error("Error fetching Configurations metadata:",e)});var s=this;this._validateProjectAndPricePlan(i,r.projectId,r.pricePlan).then(function(e){if(!e){n.show("Error: Project or Price Plan not configured.");return}s._loadDataFromOData(i).then(function(e){console.log("Loaded config data:",e);if(e.periods.length>0){n.show("Frequency: "+e.frequency)}else{n.show("Project is not configured yet")}var t=s._getRowCount(e.frequency);var o=t+3;console.log("Row count (including Downpayment, Contract Payment, and Delivery Payment):",o);var r=s._initializeTableData(o,parseInt(a.getProperty("/pricePlan").replace("YP",""))||1,e.frequency);console.log("Table data:",r);a.setProperty("/tableData",r);s._oConfigData=e;s._generateTable()}).catch(function(e){console.error("Error loading configuration:",e);n.show("Error loading configuration, defaulting to Annual");s._buildTableWithDefault(s.byId("salesTable"),parseInt(a.getProperty("/pricePlan").replace("YP",""))||1,a)})}).catch(function(e){console.error("Error validating project or price plan:",e);n.show("Error validating project or price plan: "+e.message)});this._isSending=false;this._lastSendTime=0;this._hasBeenSentSuccessfully=false},_validateProjectAndPricePlan:function(e,t,o){return new Promise(function(r,a){console.log("Validating Project ID:",t,"Price Plan:",o);var n=e.bindList("/Configurations",null,[new sap.ui.model.Sorter("createdAt",true)],[new sap.ui.model.Filter("project_projectId",sap.ui.model.FilterOperator.EQ,t)]);n.requestContexts().then(function(n){console.log("All Configurations found for validation:",n.length);if(n.length===0){console.error("Project ID not found:",t);r(false);return}const i=n[0].getObject().ID;console.log("Latest Configuration ID for validation:",i);var s=e.bindList("/PeriodRelations",null,null,[new sap.ui.model.Filter("config_ID",sap.ui.model.FilterOperator.EQ,i),new sap.ui.model.Filter("orig_period",sap.ui.model.FilterOperator.EQ,o)]);s.requestContexts().then(function(e){console.log("PeriodRelations found for price plan in latest config:",e.length);if(e.length===0){console.error("Price Plan not found in latest configuration:",o);r(false)}else{r(true)}}).catch(function(e){a(e)})}).catch(function(e){a(e)})})},_generateTable:function(){var e=this.getView();var t=e.getModel("sales");var o=t.getProperty("/pricePlan");var r=this.byId("salesTable");r.removeAllColumns();t.setProperty("/tableData",[]);t.setProperty("/futureValue","");t.setProperty("/npv","");if(!o||o===""){return}var a=parseInt(o.replace("YP",""))||1;var n=this.getOwnerComponent().getModel("npvModel");if(!n){console.error("OData model not found.");sap.m.MessageToast.show("Error: OData model not available");return}var i=this;this._loadDataFromOData(n).then(function(e){console.log("Loaded config data:",e);if(e.periods.length>0){sap.m.MessageToast.show("Frequency: "+e.frequency)}else{sap.m.MessageToast.show("Project is not configured yet")}var o=i._getRowCount(e.frequency);var n=o+3;console.log("Row count (including Downpayment and Contract Payment):",n);var s=i._initializeTableData(n,a,e.frequency);r.addColumn(new sap.m.Column({header:new sap.m.Text({text:"Period"})}));var l=new Date;var c=l.getFullYear();var u=l.getMonth()+1;var d=i._getStartPeriodIndex(e.frequency,u);var p=t.getProperty("/deliveryDate");var f=new Date(p.split(".").reverse().join("-"));var g=f.getFullYear();var v=a+(d>0?1:0);v=Math.max(v,g-c+1);for(var h=0;h<v;h++){r.addColumn(new sap.m.Column({header:new sap.m.Text({text:(c+h).toString()})}))}r.bindItems({path:"sales>/tableData",factory:function(t,o){return new sap.m.ColumnListItem({cells:i._createCells(v,e.frequency,o)})}});t.setProperty("/tableData",s);i._oConfigData=e}).catch(function(e){console.error("Error loading configuration:",e);sap.m.MessageToast.show("Error loading configuration, defaulting to Annual");i._buildTableWithDefault(r,a,t)})},_loadDataFromOData:function(e){var t=this;return new Promise(function(o,r){if(!e){r("OData model not found");return}var a=t.getView().getModel("sales");var n=a.getProperty("/project/projectId")||"";var i=a.getProperty("/pricePlan")||"5YP";setTimeout(function(){var t=e.bindList("/Configurations",null,[new sap.ui.model.Sorter("createdAt",true)],[new sap.ui.model.Filter("project_projectId",sap.ui.model.FilterOperator.EQ,n)]);t.requestContexts().then(function(t){console.log("All Configuration Contexts Retrieved:",t.length);if(t.length>0){var a=t[0].getObject();var s=a.ID;console.log("Latest Configuration ID:",s,"Created At:",a.createdAt);var l=e.bindList("/PeriodRelations",null,null,[new sap.ui.model.Filter("config_ID",sap.ui.model.FilterOperator.EQ,s),new sap.ui.model.Filter("orig_period",sap.ui.model.FilterOperator.EQ,i)]);l.requestContexts().then(function(e){console.log("Period Contexts Retrieved for latest config:",e.length);var t=e.map(function(e){var t=e.getObject();return{period:t.rel_period,totalPercentage:parseFloat(t.value)||0}});console.log("Aggregated Periods (Latest Configuration):",t);o({frequency:a.frequency,project:{projectId:a.project_projectId||n},periods:t,configId:a.ID,createdAt:a.createdAt})}).catch(function(e){console.error("Error loading periods for latest configuration:",e);r(e)})}else{console.log("No Configurations found for project "+n+", defaulting to empty configuration");o({frequency:"Annual",project:{projectId:n},periods:[],configId:null,createdAt:null})}}).catch(function(e){console.error("Error loading Configurations for project "+n+":",e);r(e)})}.bind(this),500)})},_loadDistinctProjects:function(e){var t=this;return new Promise(function(t,o){if(!e){o("OData model not found");return}setTimeout(function(){var r=e.bindList("/Configurations",null,null,null,{$select:"project_projectId"});r.requestContexts().then(function(e){console.log("OData Contexts for Distinct Projects:",e);if(e.length>0){var o=e.map(function(e){var t=e.getObject();console.log("Config Object:",t);var o=t.project_projectId;return o?{projectId:o}:null}).filter(function(e){return e!==null}).filter(function(e,t,o){return o.findIndex(t=>t.projectId===e.projectId)===t});console.log("Distinct Projects:",o);t(o)}else{console.log("No Configurations found, returning empty project list");t([])}}).catch(function(e){console.error("Error loading distinct projects:",e);o(e)})}.bind(this),500)})},_buildTableWithDefault:function(e,t,a){var n=this._getRowCount("Annual")+3;var i=this._initializeTableData(n,t,"Annual");e.addColumn(new o({header:new r({text:"Period"})}));for(var s=1;s<=t;s++){e.addColumn(new o({header:new r({text:`Year ${s}`})}))}e.bindItems({path:"sales>/tableData",factory:function(e,o){return new sap.m.ColumnListItem({cells:this._createCells(t,"Annual",o)})}.bind(this)});a.setProperty("/tableData",i);this._oConfigData={frequency:"Annual",project:{projectId:a.getProperty("/project/projectId")},periods:[]}},_getRowCount:function(e){console.log("Evaluating frequency:",e);switch(e){case"Annual":return 1;case"Semi":return 2;case"Quarter":return 4;case"Monthly":return 12;case"Daily":return 365;default:console.warn("Unknown frequency, defaulting to 1:",e);return 1}},_initializeTableData:function(e,t,o){var r=[];var a=this._getPeriodLabels(o,e);for(var n=0;n<e;n++){var i={period:a[n]};for(var s=0;s<t;s++){i[`col${s}`]=""}r.push(i)}console.log("Table data:",JSON.stringify(r,null,2));return r},_getPeriodLabels:function(e,t){var o;switch(e){case"Annual":o=["Year"];break;case"Semi":o=["H1","H2"];break;case"Quarter":o=["Q1","Q2","Q3","Q4"];break;case"Monthly":o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];break;case"Daily":o=Array.from({length:365},(e,t)=>`Day ${t+1}`);break;default:o=Array.from({length:this._getRowCount(e)},(e,t)=>`Period ${t+1}`)}return["Downpayment","Contract Payment","Delivery Payment"].concat(o.slice(0,t-3))},_onTableInputChange:function(e){var t=this.getView().getModel("sales");this._isDataChanged=true;t.setProperty("/isSimulationDone",false);this._updateSendToCXButtonState()},_createCells:function(e,t,o){var r=[new sap.m.Text({text:"{sales>period}"})];var a=o.getProperty("period");var n=new Date;var i=n.getMonth()+1;var s=n.getFullYear();var l=this._getStartPeriodIndex(t,i);var c=this._getPeriods(t);var u=this.getView().getModel("sales");var d=u.getProperty("/deliveryDate");var p=new Date(d.split(".").reverse().join("-"));var f=p.getFullYear();var g=f-s;var v=p.getMonth()+1;var h=this._getPeriodForDate(t,v);var m=parseInt(u.getProperty("/pricePlan").replace("YP",""))||1;var y=this._getPeriodForDate(t,i);for(let o=0;o<e;o++){var P=false;var D=s+o;if(a==="Downpayment"||a==="Contract Payment"){P=o===0}else if(a==="Delivery Payment"){P=o===g}else{var w=c.indexOf(a);if(w>=0){var C;if(t==="Quarter"){C=l+2}else if(t==="Semi"){C=l+1}else if(t==="Monthly"){C=l+6}else{C=c.length}var I=o*c.length+w;var S=C+c.length*m;if(I>=C&&I<S){P=true}}}var M=new sap.m.VBox({items:[new sap.m.Input({value:`{sales>col${o}}`,type:"Number",placeholder:"Enter percentage",visible:P,width:"100%",change:this._onTableInputChange.bind(this)}),new sap.m.Text({text:`{sales>amountCol${o}}`,wrapping:false,textAlign:"End",visible:{parts:[{path:"sales>/futureValue"},{path:`sales>amountCol${o}`},{value:P}],formatter:function(e,t,o){return!!e&&!!t&&o}}})],visible:P});r.push(M)}return r},_getPeriodForDate:function(e,t){switch(e){case"Quarter":if(t>=1&&t<=3)return"Q1";if(t>=4&&t<=6)return"Q2";if(t>=7&&t<=9)return"Q3";return"Q4";case"Semi":return t<=6?"H1":"H2";case"Monthly":var o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return o[t-1];case"Annual":return"Year";case"Daily":return`Day ${Math.ceil((new Date(2025,t-1,1)-new Date(2025,0,1))/(1e3*60*60*24))}`;default:return"Period 1"}},_getPeriods:function(e){switch(e){case"Quarter":return["Q1","Q2","Q3","Q4"];case"Semi":return["H1","H2"];case"Monthly":return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];default:return["Annual"]}},_getStartPeriodIndex:function(e,t){var o=0;if(e==="Quarter"){if(t>=7)o=2;else if(t>=4)o=1;else o=0}else if(e==="Semi"){if(t>=7)o=1;else o=0}else if(e==="Monthly"){o=Math.max(0,t)}return o},_formatEGP:function(e){if(!e||e===0)return"";var t=parseFloat(e).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return t+" EGP"},onSimulate:function(){var e=this.getView().getModel("sales");var t=e.getData();var o=this._oConfigData;var r=t.pricePlan;var a=parseFloat(t.discountRate)/100||0;var n=t.tableData;var i=t.deliveryDate||"15.09.2025";var s=new Date(i.split(".").reverse().join("-"));var l=s.getFullYear();var c=(new Date).getFullYear();var u=(new Date).getMonth()+1;var d=l-c;var p=s.getMonth()+1;var f=this._getPeriodForDate(o.frequency,p);var g=this._getStartPeriodIndex(o.frequency,u);var v=this._getPeriodForDate(o.frequency,u);console.log("Sales Model Data:",t);console.log("Config Data:",o);console.log("Table Data Periods and col0:",n.map(e=>({period:e.period,col0:e.col0})));if(!r||!t.unitNpv||!t.discountRate||n.length===0||!t.project.projectId){sap.m.MessageToast.show("Please fill in Unit NPV, Discount Rate, Price Plan, Project, and table data before simulating.");return}var h=parseInt(r.replace("YP",""))||1;var m=h+(g>0?1:0);m=Math.max(m,d+1);var y=this._getRowCount(o.frequency);var P=o.periods.find(e=>e.period.toLowerCase()==="downpayment")?.totalPercentage||0;var D=o.periods.find(e=>e.period.toLowerCase()==="delivery")?.totalPercentage||0;var w=Array(h).fill(0);o.periods.forEach(e=>{if(e.period.toLowerCase().includes("yp")){var t=parseInt(e.period.replace("YP",""))-1;if(t>=0&&t<h){w[t]=e.totalPercentage||0}}});console.log("Configured Percentages:",{fConfigDownpayment:P,fConfigDelivery:D,aConfigPercentages:w});var C=0;var I=0;var S=0;n.forEach(function(e,t){console.log("Row Data:",e);if(e.period.toLowerCase()==="downpayment"||t===0&&e.period.toLowerCase().includes("downpayment")){C=parseFloat(e.col0)||0;console.log("Downpayment Percentage:",C)}if(e.period.toLowerCase()==="contract payment"||t===1&&e.period.toLowerCase().includes("contract payment")){I=parseFloat(e.col0)||0;console.log("Contract Payment Percentage:",I)}if(e.period.toLowerCase()==="delivery payment"){var o=parseFloat(e[`col${d}`])||0;S=o;console.log("Delivery Payment Percentage:",S)}});if(C+I<P){sap.m.MessageToast.show(`Error: Downpayment (${C.toFixed(2)}%) is less than configured Downpayment (${P.toFixed(2)}%) for Year 1 of project ${t.project.projectId}.`);return}var M=0;if(d>=0&&d<m){var b=Array(d+1).fill(0);n.forEach(function(e){for(var t=0;t<=d;t++){b[t]+=parseFloat(e[`col${t}`])||0}});var j=[];b.reduce(function(e,t,o){e+=t;j[o]=e;return e},0);M=j[d]||0}else{var F=Array(m).fill(0);n.forEach(function(e){for(var t=0;t<m;t++){F[t]+=parseFloat(e[`col${t}`])||0}});var _=[];F.reduce(function(e,t,o){e+=t;_[o]=e;return e},0);M=_.length?_[_.length-1]:0}console.log("Cumulative Delivery Percentage:",M);if(M<D){sap.m.MessageToast.show(`Error: Cumulative payments up to ${f} ${l} (${M.toFixed(2)}%) are less than configured Delivery percentage (${D.toFixed(2)}%) for project ${t.project.projectId}.`);return}var x=Array(m).fill(0);var T=Array(h).fill(0);n.forEach(function(e){if(e.period.toLowerCase()==="downpayment"||e.period.toLowerCase()==="contract payment"){var t=parseFloat(e.col0)||0;x[0]+=t;T[0]+=t;console.log(`Row ${e.period}, Year ${c}, Plan Year 1, Value: ${t}`)}else if(e.period.toLowerCase()==="delivery payment"){if(d>=0&&d<m){var t=parseFloat(e[`col${d}`])||0;x[d]+=t;var r=this._getPeriods(o.frequency).indexOf(f);var a=d*y+r;var n=Math.floor(a/y)-1;if(n<0)n=0;if(n>=0&&n<h){T[n]+=t}console.log(`Row ${e.period}, Year ${d+c}, Plan Year ${n+1}, Value: ${t}`)}}else{for(var i=0;i<m;i++){var s=this._getPeriods(o.frequency).indexOf(e.period);if(s>=0){var l=i*y+s;var n=Math.floor(l/y)-1;if(n<0)n=0;if(n>=0&&n<h){var t=parseFloat(e[`col${i}`])||0;x[i]+=t;T[n]+=t;console.log(`Row ${e.period}, Year ${i+c}, Plan Year ${n+1}, Value: ${t}`)}}}}},this);for(var E=1;E<h;E++){T[E]+=T[E-1]}for(var E=0;E<h;E++){if(T[E]<w[E]){sap.m.MessageToast.show(`Error: Cumulative total percentage for Year ${E+1} (${T[E].toFixed(2)}%) is less than configured percentage (${w[E].toFixed(2)}%) for project ${t.project.projectId}.`);return}}var A=0;n.forEach(function(e){for(var t=0;t<m;t++){A+=parseFloat(e[`col${t}`])||0}});if(A!==100){sap.m.MessageToast.show(`Error: Total percentage (${A.toFixed(2)}%) does not equal 100% for project ${t.project.projectId}.`);return}var O=parseFloat(t.unitNpv)||0;var $=h*y;var Y=Array($).fill(0);n.forEach(function(e){if(e.period.toLowerCase()!=="downpayment"&&e.period.toLowerCase()!=="delivery payment"&&e.period.toLowerCase()!=="contract payment"){var t=this._getPeriods(o.frequency).indexOf(e.period);if(t>=0){for(var r=0;r<m;r++){var a=r*y+t;var n=Math.floor(a/y)-1;if(n<0)n=0;if(n>=0&&n<h){var i=n*y+t;if(i<$){var s=(parseFloat(e[`col${r}`])||0)/100;Y[i]+=s;console.log(`E Calc Year ${r+c}, Period ${e.period}, Plan Period ${i}:`,{basePercentage:s})}}}}}},this);const q=(1+a)**(1/y)-1;let L=0;for(let e=0;e<Y.length;e++){L+=Y[e]/(1+q)**(e+1)}L+=(C+I+S)/100;var N=O*(1/L);n.forEach(function(e){for(var t=0;t<m;t++){var o=parseFloat(e[`col${t}`])||0;var r=o/100*N;e[`amountCol${t}`]=r>0?this._formatEGP(r):""}}.bind(this));var R=L.toFixed(6);var Q=N.toFixed(2);e.setProperty("/futureValue",this._formatEGP(N));e.setProperty("/npv",R);e.setProperty("/tableData",n);e.refresh(true);sap.m.MessageToast.show(`Simulation completed: Future Value = ${Q}, NPV = ${R}`);console.log("Frequency:",o.frequency,"Periods per Year:",y,"E Array:",Y,"Downpayment:",C,"Contract Payment:",I,"Delivery Payment:",S,"Cumulative Delivery:",M,"Cumulative Totals:",T,"NPV (full precision):",L,"NPV (display):",R,"Future Value (full precision):",N,"Future Value (display):",Q);e.setProperty("/isSimulationDone",true)},onSendToCX:function(){if(this._isSending){sap.m.MessageToast.show("Send operation is already in progress. Please wait...");return}var e=Date.now();if(e-this._lastSendTime<3e3){sap.m.MessageToast.show("Please wait a moment before sending again");return}var t=this.getView().getModel("sales");var o=t.getProperty("/isSimulationDone");if(!o){sap.m.MessageBox.warning("Please run the simulation first before sending to CX.",{title:"Simulation Required",actions:[sap.m.MessageBox.Action.OK]});return}var r=t.getData();var a=[];if(!r.futureValue||r.futureValue==="")a.push("Future Value");if(!r.npv||r.npv==="")a.push("NPV");if(!r.leadId||r.leadId==="")a.push("Lead ID");if(!r.psId||r.psId==="")a.push("PS ID");if(!r.pcId||r.pcId==="")a.push("PC ID");if(!r.unitId||r.unitId==="")a.push("Unit ID");if(!r.project.projectId||r.project.projectId==="")a.push("Project ID");if(a.length>0){sap.m.MessageBox.error("Missing required fields: "+a.join(", "),{title:"Validation Error",actions:[sap.m.MessageBox.Action.OK]});return}var n=r.tableData||[];var i=false;var s=0;n.forEach(function(e){for(var t in e){if(t.startsWith("col")&&parseFloat(e[t])>0){i=true;s+=parseFloat(e[t])||0}}});if(!i){sap.m.MessageBox.warning("Please enter payment schedule data before sending to CX.",{title:"No Payment Data",actions:[sap.m.MessageBox.Action.OK]});return}if(Math.abs(s-100)>.01){sap.m.MessageBox.warning("Payment schedule must total 100%. Current total: "+s.toFixed(2)+"%",{title:"Invalid Payment Schedule",actions:[sap.m.MessageBox.Action.OK]});return}sap.m.MessageBox.confirm("Are you sure you want to send this payment plan to CX? This action cannot be undone.",{title:"Confirm Send to CX",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){this._executeSendToCX()}}.bind(this)})},_executeSendToCX:function(){this._isSending=true;this._lastSendTime=Date.now();this._updateSendButtonState();var e=this.getView().getModel("sales");var t=e.getData();var o=t.projectType||"";var r=o.toLowerCase().includes("NUCA")?"C":"N";var a=function(e){if(!e||e==="")return"0";return e.replace(/,/g,"").replace(" EGP","")};var n=[];var i=t.tableData||[];var s=parseInt(t.pricePlan.replace("YP",""))||1;var l=new Date(t.deliveryDate).getFullYear()-(new Date).getFullYear();var c=this._oConfigData||{frequency:"Annual"};var u=c.frequency||"Annual";var d,p;switch(u){case"Monthly":d="Z02";p=1;break;case"Quarter":d="Z03";p=3;break;case"Semi":d="Z04";p=6;break;case"Annual":default:d="Z05";p=12;break}var f=0;i.forEach(function(e){if(e.period!=="Downpayment"&&e.period!=="Contract Payment"&&e.period!=="Delivery Payment"&&e.period!==""){for(var t=0;t<s;t++){if(parseFloat(e["col"+t])>0){f++}}}});var g=0;i.forEach(function(e){if(e.period==="Downpayment"){g=parseFloat(e.col0)||0}});n.push({conditionType:"Z"+r+"01",conditionPercentage:g.toFixed(2),conditionBasePrice:"ZTP",conditionCalcMethod:"Z01",conditionFrequency:"Z01",conditionDueInMonth:"1",conditionInstallments:"1",conditionnoYears:"1"});var v=0;i.forEach(function(e){if(e.period==="Contract Payment"){v=parseFloat(e.col0)||0}});n.push({conditionType:"Z"+r+"03",conditionPercentage:v.toFixed(2),conditionBasePrice:"ZTP",conditionCalcMethod:"Z01",conditionFrequency:"Z01",conditionDueInMonth:"1",conditionInstallments:"1",conditionnoYears:"1"});var h=0;i.forEach(function(e){if(e.period==="Delivery Payment"){h=parseFloat(e["col"+l])||0}});n.push({conditionType:"Z"+r+"05",conditionPercentage:h.toFixed(2),conditionBasePrice:"ZTP",conditionCalcMethod:"Z01",conditionFrequency:"Z01",conditionDueInMonth:"1",conditionInstallments:"1",conditionnoYears:"1"});var m=0;i.forEach(function(e){if(e.period!=="Downpayment"&&e.period!=="Contract Payment"&&e.period!=="Delivery Payment"&&e.period!==""){for(var t=0;t<=s;t++){m+=parseFloat(e["col"+t])||0}}});n.push({conditionType:"Z"+r+"02",conditionPercentage:m.toFixed(2),conditionBasePrice:"ZTP",conditionCalcMethod:d,conditionFrequency:d,conditionDueInMonth:p.toString(),conditionInstallments:f.toString(),conditionnoYears:s.toString()});var y={custompaymentPlan:[{leadID:t.leadId||"",pcID:t.pcId||"",unitID:t.unitId||"",projectID:t.project.projectId||"",finaPriceAmount:a(t.futureValue),currency:"EGP",noOfYears:s.toString()||"",Conditions:n}]};var P=this.getOwnerComponent().getModel("cpiModel");if(!P){console.error("cpiModel is undefined:",P);sap.m.MessageBox.error("CPI model is not available. Please contact system administrator.",{title:"System Error"});this._resetSendState();return}var D=P.bindContext("/sendToCX(...)");D.setParameter("payload",JSON.stringify(y));D.setParameter("environment",t.tenant);var w=this;D.execute().then(function(e){var o=D.getBoundContext().getObject();console.log("Response from first CPI:",o);w._executeSecondFlow(t,o,t.tenant)}).catch(function(e){console.error("Error from first CPI:",e);sap.m.MessageBox.error("Failed to send payment plan to CX: "+(e.message||"Unknown error"),{title:"Send Error",details:e.responseText||"Please try again or contact support if the problem persists."});w._resetSendState()})},_executeSecondFlow:function(e,t,o){var r=this;var a=this.getOwnerComponent().getModel("cpiModel");var n=this._oConfigData||{frequency:"Annual"};var i=n.frequency||"Annual";var s=e.tableData||[];var l=parseInt(e.pricePlan.replace("YP",""))||1;var c=new Date(e.deliveryDate).getFullYear()-(new Date).getFullYear();var u=[];var d=(new Date).getFullYear();var p=(new Date).toISOString().split("T")[0];var f=e.deliveryDate;var g=new Date;var v=g.getMonth();var h=function(e){if(!e||e==="")return"0";return e.replace(/,/g,"").replace(" EGP","")};var m;if(i==="Quarter"){m=[{period:"Q1",month:0},{period:"Q2",month:3},{period:"Q3",month:6},{period:"Q4",month:9}]}else if(i==="Semi"){m=[{period:"H1",month:0},{period:"H2",month:6}]}else if(i==="Monthly"){m=[{period:"Jan",month:0},{period:"Feb",month:1},{period:"Mar",month:2},{period:"Apr",month:3},{period:"May",month:4},{period:"Jun",month:5},{period:"Jul",month:6},{period:"Aug",month:7},{period:"Sep",month:8},{period:"Oct",month:9},{period:"Nov",month:10},{period:"Dec",month:11}]}else{m=[{period:"Annual",month:7}]}var y=e.projectType||"";var P=y.toLowerCase().includes("NUCA")?"C":"N";var D=0;s.forEach(function(e){if(e.period==="Downpayment"){D=h(e.amountCol0);if(D>0){u.push({conditionType:"Z"+P+"01",dueDate:p,Amount:D.toString(),Currency:"EGP"})}}});var w=0;s.forEach(function(e){if(e.period==="Contract Payment"){w=h(e.amountCol0);if(w>0){var t=new Date;if(i==="Quarter"){t.setMonth(t.getMonth()+3)}var o=t.toISOString().split("T")[0];u.push({conditionType:"Z"+P+"03",dueDate:o,Amount:w.toString(),Currency:"EGP"})}}});var C=0;s.forEach(function(t){if(t.period==="Delivery Payment"){C=h(t["amountCol"+c]);if(C>0){u.push({conditionType:"Z"+P+"05",dueDate:e.deliveryDate,Amount:C.toString(),Currency:"EGP"})}}});var I=this._getPeriods(i);var S=this._getStartPeriodIndex(i,v);var M=i==="Quarter"?I.slice(S):i==="Semi"?I.slice(S):i==="Monthly"?I.slice(v):I;console.log("Adjusted periods for 2025:",M);s.forEach(function(e){if(e.period!=="Downpayment"&&e.period!=="Contract Payment"&&e.period!=="Delivery Payment"&&e.period!==""){for(var t=0;t<=l;t++){var o=h(e["amountCol"+t]);if(o>0){var r=t===0&&(i==="Quarter"||i==="Semi"||i==="Monthly")?M.indexOf(e.period):I.indexOf(e.period);if(r>=0){var a=new Date(g);var n=t;var s=m.find(e=>e.period===(t===0&&(i==="Quarter"||i==="Semi"||i==="Monthly")?M[r]:I[r]));var c=s.month;if(i==="Quarter"){var d=v%3;c+=d;if(c>=12){c-=12;n+=1}if(t===0&&c<=v){n+=1}}a.setFullYear((new Date).getFullYear()+n);a.setMonth(c);var p=a.toISOString().split("T")[0];console.log("Period:",e.period,"Year:",(new Date).getFullYear()+n,"Due Date:",p,"iMonth:",c);u.push({conditionType:"Z"+P+"02",dueDate:p,Amount:o.toString(),Currency:"EGP"})}}}}}.bind(this));var b={custompaymentSimulation:[{customPsID:e.psId,finalPrice:h(e.futureValue),Data:u}]};var j=a.bindContext("/sendToNewCX(...)");j.setParameter("payload",JSON.stringify(b));j.setParameter("environment",o);j.execute().then(function(e){var t=j.getBoundContext().getObject();console.log("Response from new CPI:",t);console.log("Used tenant/environment:",o);sap.m.MessageBox.success(`Payment plan and simulation sent to CX (${o}) successfully!`,{title:"Success"});r._hasBeenSentSuccessfully=true;r._resetSendState()}).catch(function(e){console.error("Error from new CPI:",e);sap.m.MessageBox.error(`Payment plan was sent, but simulation failed (${o}): ${e.message||"Unknown error"}`,{title:"Partial Success",details:"The payment plan was successfully sent, but the simulation data could not be transmitted."});r._resetSendState()})},_updateSendButtonState:function(){var e=this.byId("sendToCXButton");if(e){e.setEnabled(!this._isSending);e.setText(this._isSending?"Sending...":"Send to CX");if(this._isSending){e.setType("Emphasized")}else{e.setType("Default")}}},_resetSendState:function(){this._isSending=false;this._updateSendButtonState()}})});
//# sourceMappingURL=Sales.controller.js.map