sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/Input","sap/m/MessageToast"],function(e,a,t,n,r,o){"use strict";return e.extend("project1.controller.Sales",{onInit:function(){const e=new URLSearchParams(window.location.search);const t=e.get("discountRate")||"";const n=e.get("unitNpv")||"";const r=e.get("pricePlan")||"";const l=e.get("leadId")||"";const i=new a({unitNpv:n,discountRate:t,leadId:l,pricePlan:r,tableData:[],futureValue:"",npv:""});this.getView().setModel(i,"sales");var s=this.getOwnerComponent().getModel("npvModel");if(!s){console.error("OData model not found.");o.show("Error: OData model not available");return}var u=this;this._loadDataFromOData(s).then(function(e){console.log("Loaded config data:",e);o.show("Frequency: "+e.frequency);var a=u._getRowCount(e.frequency);var t=a+2;console.log("Row count (including Downpayment and Contract Payment):",t);var n=u._initializeTableData(t,parseInt(i.getProperty("/pricePlan").replace("YP",""))||1,e.frequency);i.setProperty("/tableData",n);u._oConfigData=e;u._generateTable()}).catch(function(e){console.error("Error loading frequency:",e);o.show("Error loading frequency, defaulting to Annual");u._buildTableWithDefault(u.byId("salesTable"),parseInt(i.getProperty("/pricePlan").replace("YP",""))||1,i)})},onPricePlanChange:function(e){var a=e.getParameter("selectedItem").getKey();var t=this.getView().getModel("sales");t.setProperty("/pricePlan",a);this._generateTable()},_generateTable:function(){var e=this.getView();var a=e.getModel("sales");var r=a.getProperty("/pricePlan");var l=this.byId("salesTable");l.removeAllColumns();a.setProperty("/tableData",[]);a.setProperty("/futureValue","");a.setProperty("/npv","");if(!r||r===""){return}var i=parseInt(r.replace("YP",""))||1;var s=this.getOwnerComponent().getModel("npvModel");if(!s){console.error("OData model not found.");o.show("Error: OData model not available");return}var u=this;this._loadDataFromOData(s).then(function(e){console.log("Loaded config data:",e);o.show("Frequency: "+e.frequency);var r=u._getRowCount(e.frequency);var s=r+2;console.log("Row count (including Downpayment and Contract Payment):",s);var c=u._initializeTableData(s,i,e.frequency);l.addColumn(new t({header:new n({text:"Period"})}));for(var d=1;d<=i;d++){l.addColumn(new t({header:new n({text:`Year ${d}`})}))}l.bindItems({path:"sales>/tableData",factory:function(a,t){return new sap.m.ColumnListItem({cells:u._createCells(i,e.frequency,t)})}});a.setProperty("/tableData",c);u._oConfigData=e}).catch(function(e){console.error("Error loading frequency:",e);o.show("Error loading frequency, defaulting to Annual");u._buildTableWithDefault(l,i,a)})},_loadDataFromOData:function(e){return new Promise(function(a,t){if(!e){t("OData model not found");return}e.bindList("/Configurations",undefined,undefined,undefined,{$expand:"periods($expand=percentages)"}).requestContexts().then(function(e){console.log("OData Contexts Retrieved:",e);if(e.length>0){var t=e[0].getObject();console.log("Raw OData Response:",JSON.stringify(t,null,2));a({frequency:t.frequency,periods:t.periods.results||t.periods})}else{console.log("No Configurations found, defaulting to Annual");a({frequency:"Annual",periods:[]})}}).catch(function(e){console.error("Error loading Configurations:",e);t(e)})})},_buildTableWithDefault:function(e,a,r){var o=this._getRowCount("Annual")+2;var l=this._initializeTableData(o,a,"Annual");e.addColumn(new t({header:new n({text:"Period"})}));for(var i=1;i<=a;i++){e.addColumn(new t({header:new n({text:`Year ${i}`})}))}e.bindItems({path:"sales>/tableData",factory:function(e,t){return new sap.m.ColumnListItem({cells:this._createCells(a,"Annual",t)})}.bind(this)});r.setProperty("/tableData",l);this._oConfigData={frequency:"Annual",periods:[]}},_getRowCount:function(e){console.log("Evaluating frequency:",e);switch(e){case"Annual":return 1;case"Semi":return 2;case"Quarter":return 4;case"Monthly":return 12;case"Daily":return 365;default:console.warn("Unknown frequency, defaulting to 1:",e);return 1}},_initializeTableData:function(e,a,t){var n=[];var r=this._getPeriodLabels(t,e);for(var o=0;o<e;o++){var l={period:r[o]};for(var i=0;i<a;i++){l[`col${i}`]=""}n.push(l)}console.log("Table data:",JSON.stringify(n,null,2));return n},_getPeriodLabels:function(e,a){var t;switch(e){case"Annual":t=["Year"];break;case"Semi":t=["H1","H2"];break;case"Quarter":t=["Q1","Q2","Q3","Q4"];break;case"Monthly":t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];break;case"Daily":t=Array.from({length:365},(e,a)=>`Day ${a+1}`);break;default:t=Array.from({length:this._getRowCount(e)},(e,a)=>`Period ${a+1}`)}return["Downpayment","Contract Payment"].concat(t.slice(0,a-2))},_createCells:function(e,a,t){var o=[new n({text:"{sales>period}"})];var l=t.getProperty("period");for(let a=0;a<e;a++){var i=l!=="Downpayment"&&l!=="Contract Payment"||a===0;o.push(new r({value:`{sales>col${a}}`,type:"Number",placeholder:"Enter value",visible:i}))}return o},onSimulate:function(){var e=this.getView().getModel("sales");var a=e.getData();var t=this._oConfigData||{frequency:"Annual",periods:[]};var n=a.pricePlan;var r=parseFloat(a.discountRate)/100||0;var l=a.tableData;console.log("Sales Model Data:",a);console.log("Config Data:",t);if(!n||!a.unitNpv||!a.discountRate||l.length===0){o.show("Please fill in Unit NPV, Discount Rate, Price Plan, and table data before simulating.");return}var i=parseFloat(a.unitNpv)||0;var s=parseInt(n.replace("YP",""))||1;var u=this._getRowCount(t.frequency);var c=0,d=0;l.forEach(function(e){console.log("Row Data:",e);if(e.period==="Downpayment"){c=(parseFloat(e.col0)||0)/100;console.log("Downpayment Percentage:",c)}else if(e.period==="Contract Payment"){d=(parseFloat(e.col0)||0)/100;console.log("Contract Payment Percentage:",d)}});var f=s*u;var p=[];for(var g=1;g<=s;g++){l.forEach(function(e,a){if(e.period!=="Downpayment"&&e.period!=="Contract Payment"){var t=(parseFloat(e[`col${g-1}`])||0)/100;var n=a-2;if(n>=0&&n<u){p.push(t);console.log(`E Calc Year ${g}, Period ${e.period}:`,{basePercentage:t})}}});while(p.length<g*u){p.push(0)}}const y=(1+r)**(1/u)-1;let v=0;for(let e=0;e<p.length;e++){v+=p[e]/(1+y)**(e+1)}v+=c+d;var h=i*(1/v);var m=v.toFixed(6);var w=h.toFixed(2);e.setProperty("/futureValue",w);e.setProperty("/npv",m);o.show(`Simulation completed: Future Value = ${w}, NPV = ${m}`);console.log("Frequency:",t.frequency,"Periods per Year:",u,"E Array:",p,"Downpayment:",c,"Contract Payment:",d,"NPV (full precision):",v,"NPV (display):",m,"Future Value (full precision):",h,"Future Value (display):",w)}})});
//# sourceMappingURL=Sales.controller.js.map