sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/Input","sap/m/MessageToast"],function(e,t,a,r,n,o){"use strict";return e.extend("project1.controller.Configuration",{onInit:function(){var e=new t({frequency:"Annual"});this.getView().setModel(e,"config");var a={};a["First 4 Months"]=Array(20).fill().map(()=>({value:""}));for(var r=1;r<=20;r++){var n=r+"YP";a[n]=Array(20).fill().map(()=>({value:""}))}var o=new t(a);console.log("Initial Periods Model:",JSON.stringify(o.getData(),null,2));o.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);this.getView().setModel(o,"periods");var s=this.getOwnerComponent().getModel("npvModel");this._loadDataFromOData(s,e,o).then(()=>{this._createPeriodTable()}).catch(e=>{console.error("Failed to load data:",e)})},_createPeriodTable:function(){var e=this.byId("periodsTable");var t=this.getView().getModel("periods");var o=t.getData();e.removeAllColumns();e.unbindItems();var s=20;e.addColumn(new a({header:new r({text:"Period Name"})}));for(var i=1;i<=s;i++){e.addColumn(new a({header:new r({text:i+"YP"})}))}e.bindItems({path:"periods>/",factory:function(e,t){var a=t.getPath().split("/").pop();var o=[];o.push(new r({text:a}));for(var i=1;i<=s;i++){if(a==="First 4 Months"){var l=i-1;o.push(new n({value:"{periods>/"+a+"/"+l+"/value}",type:"Number",change:this._onInputChange.bind(this)}))}else{var u=parseInt(a.replace("YP",""),10);if(!isNaN(u)&&i>=u){var d=i-u;o.push(new n({value:"{periods>/"+a+"/"+d+"/value}",type:"Number",change:this._onInputChange.bind(this)}))}else{o.push(new r({text:""}))}}}return new sap.m.ColumnListItem({cells:o})}.bind(this)})},_onInputChange:function(e){var t=e.getSource();var a=t.getValue().trim();var r=t.getBinding("value").getPath();var n="/periods"+r;var s=this.getView().getModel("periods");console.log("Full Path:",n,"New Value:",a,"Current Model Value:",s.getProperty(n));if(a===""){return}var i=parseFloat(a);if(isNaN(i)||i<0||i>100){t.setValueState("Error");t.setValueStateText("Please enter a valid number between 0 and 100.");o.show("Please enter a valid number between 0 and 100.")}else{t.setValueState("None")}},_loadDataFromOData:function(e,t,a){if(!e){console.warn("OData model not found; skipping load");return Promise.resolve()}return e.bindList("/Configurations",undefined,undefined,undefined,{$expand:"periods($expand=percentages)"}).requestContexts().then(function(e){if(e.length>0){var r=e[0].getObject();t.setData({frequency:r.frequency,lastUpdatedBy:r.lastUpdatedBy||"Unknown"});var n=a.getData();var o={...n};if(r.periods){var s=r.periods.results||r.periods;s.forEach(function(e){var t=e.periodName;var a=e.percentages.results||e.percentages;o[t]=Array(20).fill().map((e,t)=>({value:a[t]&&a[t].value!=null?a[t].value.toString():""}))})}a.setData(o);console.log("Merged Periods Model:",JSON.stringify(o,null,2))}else{console.log("No Configurations found; using defaults.")}})},onSave:function(){var e=this.getView().getModel("periods");var t=this.getView().getModel("config");if(!e||!t){console.error("Required models not found.");return}var a=e.getData();for(var r in a){var n=0;a[r].forEach(function(e){var t=parseFloat(e.value)||0;n+=t});if(n>100){o.show(`Total for ${r} exceeds 100% (${n.toFixed(2)}%). Please correct.`);return}}var s=t.getData();var i=Object.keys(a).map(function(e){return{periodName:e,percentages:a[e].map(function(e,t){return{index:t,value:parseFloat(e.value)||0}})}});var l={frequency:s.frequency,periods:i};console.log("Payload:",JSON.stringify(l,null,2));var u=this.getOwnerComponent().getModel("npvModel");if(!u){console.error("OData model not found.");o.show("Error: OData model not available");return}u.bindList("/Configurations").requestContexts().then(function(e){if(e.length>0){var t=e[0].getObject().ID;u.update(`/Configurations(${t})`,l,{success:function(){o.show("Data updated successfully!");console.log("Update successful")},error:function(e){console.error("Error updating data:",e);o.show("Failed to update data: "+e.message)}})}else{u.bindList().create()("/Configurations",l,{success:function(){o.show("Data saved successfully!");console.log("Create successful")},error:function(e){console.error("Error saving data:",e);o.show("Failed to save data: "+e.message)}})}}).catch(function(e){console.error("Error checking existing configurations:",e);o.show("Error accessing service: "+e.message)})}})});
//# sourceMappingURL=Configuration.controller.js.map